#!/bin/bash
# testing.sh -- testing file for indexer
# Usage: make test
# Input: none
# Output: Testing results, see testing.out for more specific results
#Verification Method: "Manual verification of files -- files match expectations"
#
# Author: Salifyanji J Namwila October 19 2021
# CS50 Fall 2021.
# Based on testing script by Temi Prioleau
# Feb 5, 2020
#
#INDEXER ARGUMENTS: ./indexer pageDirectory indexFilename
#example: ./indexer   ../tse-output/toscrape-depth-2  ../tse-index-output/toscrape-depth-2

#INDEXTEST ARGUMENTS: ./indextest oldIndexFilename newIndexFilename 
#example:  ./indextest ../tse-index-output/toscrape-depth-2  ../tse-index-sorted-output/toscrape-depth-2 

chmod +x testing.sh # change mode of .out file to executable

#  make parent directory outside cralwer to hold all new directories made in this test
mkdir ../tse-index-output

make
make[1]: Nothing to be done for `all'.

mkdir  ../tse-index-output/argstest-index


echo "Integration testing for indexer module."
Integration testing for indexer module.
echo "PLEASE ensure you have tse-output downloading before running the below script."
PLEASE ensure you have tse-output downloading before running the below script.
echo "For details on how to download tse-output, please see the general README."
For details on how to download tse-output, please see the general README.
echo "Currently using -DTEST flag to see progress indicators (e.g. current file ID)."
Currently using -DTEST flag to see progress indicators (e.g. current file ID).
echo "(Please comment out for brevity, see Makefile in common to delete the flag)"
(Please comment out for brevity, see Makefile in common to delete the flag)
echo "Note, using -qy tags for diff, meaning that only if there are differences will they be displayed. The comparison is done side by side"
Note, using -qy tags for diff, meaning that only if there are differences will they be displayed. The comparison is done side by side
echo "Please use valgrind to check for memory leaks"
Please use valgrind to check for memory leaks

echo "=================================================================="
==================================================================

#************************************* various commandline arguments testing block ************************************#
### The tests cases defined in this block should  all fail ###
echo "Section 0: Testing: Parameter Checks"
Section 0: Testing: Parameter Checks

echo "Testing indexer (error-handling)"
Testing indexer (error-handling)

# 2 arguments
echo "Error handling: Insufficient arguments"
Error handling: Insufficient arguments
./indexer ../tse-output/letters-depth-0
incorrect number of parameters
if [ $? -ne 0 ]; then
    echo >&2 "Error caught: Insufficient arguments provided"

fi
Error caught: Insufficient arguments provided

# 4 arguments
echo "Error handling: Too many arguments"
Error handling: Too many arguments
./indexer ../tse-output/letters-depth-0 ../tse-index-output/argstest-index ../tse-output/
incorrect number of parameters
if [ $? -ne 0 ]; then
    echo >&2 "Error caught: Too many arguments provided"

fi
Error caught: Too many arguments provided

# invalid pagedirectory (not crawler-produced)
echo "Error handling: Testing indexer on invalid pagedirectory (not crawler-produced)"
Error handling: Testing indexer on invalid pagedirectory (not crawler-produced)
./indexer ../tse-index-output/argstest-index ../tse-index-output/argstest-index-out
 Cannot verify whether directory Crawler
if [ $? -ne 0 ]; then
    echo >&2 "Error caught: Indexer requires a crawler-produced directory"

fi
Error caught: Indexer requires a crawler-produced directory

# invalid pagedirectory (non-existent)
echo "Error-handling: Testing crawler on invalid pagedirectory (non-existent)"
Error-handling: Testing crawler on invalid pagedirectory (non-existent)
./indexer ../tse-output-not-exist/ ../tse-index-output/argstest-index-out
 Cannot verify whether directory Crawler
if [ $? -eq 0 ]; then
    echo >&2 "Error caught: Indexer ignores a non-existent pagedirectory"

fi

# invalid directory (no write permission)
mkdir ../tse-index-output/notWriteable
chmod -w ../tse-index-output/notWriteable

echo "Error-handling: Testing indexer on invalid directory (no write permission)"
Error-handling: Testing indexer on invalid directory (no write permission)
./indexer ../tse-output/letters-depth-0 ../tse-index-output/notWriteable/letters-index-0
MALLOC FAILED: indexFilename could not be opened for writing

if [ $? -ne 0 ]; then
    echo >&2 "Error caught: Directory must be writable"

fi
Error caught: Directory must be writable

chmod +w ../tse-index-output/notWriteable

#*****************************************Regular(valid) cases testing block **********************************#
echo "============================================================"
============================================================

# The tests cases defined in this block should  all pass ###
echo " Section 1 Testing: Indexing letters, toscrape and wikipedia crawler produced directories  "
 Section 1 Testing: Indexing letters, toscrape and wikipedia crawler produced directories  

echo "Testing indexer on letters at depth 0, 1, 2, 3, 4, 5, 6"
Testing indexer on letters at depth 0, 1, 2, 3, 4, 5, 6



# indexer on letters at depth 0
echo "Testing indexer on letters at depth 0 file"
Testing indexer on letters at depth 0 file
./indexer ../tse-output/letters-depth-0 ../tse-index-output/letters-index-0
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on letters at depth 0 failed"
    exit 1
fi



# indexer on letters at depth 1
echo "Testing indexer on letters at depth 1 file"
Testing indexer on letters at depth 1 file
./indexer ../tse-output/letters-depth-1 ../tse-index-output/letters-index-1
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on letters at depth 1 failed"
    exit 1
fi




# indexer on letters at depth 2
echo "Testing indexer on letters at depth 2 file"
Testing indexer on letters at depth 2 file
./indexer ../tse-output/letters-depth-2/ ../tse-index-output/letters-index-2
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on letters at depth 2 failed"
    exit 1
fi




# indexer on letters at depth 3
echo "Testing indexer on letters at depth 3 file"
Testing indexer on letters at depth 3 file
./indexer ../tse-output/letters-depth-3/ ../tse-index-output/letters-index-3
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on letters at depth 3 failed"
    exit 1
fi




# indexer on letters at depth 4

echo "Testing on letters html at depth 4 (contains loops)"
Testing on letters html at depth 4 (contains loops)
./indexer ../tse-output/letters-depth-4/ ../tse-index-output/letters-index-4
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on letters html failed"
    exit 1
fi



echo "Manual verification of files -- no words are missing or duplicated"
Manual verification of files -- no words are missing or duplicated

echo "========================================================="
=========================================================

echo "Testing indexer on Wikipedia playground at depth 0, 1, 2"
Testing indexer on Wikipedia playground at depth 0, 1, 2




# indexer on wikipedia  at depth 0
echo "Testing indexer on Wikipedia at depth 0 file"
Testing indexer on Wikipedia at depth 0 file
./indexer ../tse-output/wikipedia-depth-0 ../tse-index-output/wikipedia-index-0
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on wikipedia at depth 0 failed"
    exit 1
fi




# indexer on wikipedia  at depth 1
echo "Testing indexer on Wikipedia at depth 1 file"
Testing indexer on Wikipedia at depth 1 file
./indexer ../tse-output/wikipedia-depth-1/ ../tse-index-output/wikipedia-index-1
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on wikipedia at depth 1 failed"
    exit 1
fi





# indexer on wikipedia  at depth 2
echo "Testing indexer on Wikipedia at depth 2 file"
Testing indexer on Wikipedia at depth 2 file
./indexer ../tse-output/wikipedia-depth-2/ ../tse-index-output/wikipedia-index-2
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on wikipedia at depth 2 failed"
    exit 1
fi



# indexer on toscrape  at depth 0
echo "Testing indexer on toscrape at depth 0 file"
Testing indexer on toscrape at depth 0 file
./indexer ../tse-output/toscrape-depth-0/ ../tse-index-output/toscrape-index-0
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on toscrape at depth 0 failed"
    exit 1
fi




# indexer on toscrape  at depth 1
echo "Testing indexer on toscrape at depth 1 file"
Testing indexer on toscrape at depth 1 file
./indexer ../tse-output/toscrape-depth-1/ ../tse-index-output/toscrape-index-1
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on toscrape at depth 1 failed"
    exit 1
fi




# indexer on toscrape  at depth 2
echo "Testing indexer on toscrape at depth 2 file"
Testing indexer on toscrape at depth 2 file
./indexer ../tse-output/toscrape-depth-2/ ../tse-index-output/toscrape-index-2
Building index...
Saving index...
Index Built and Saved.
if [ $? -ne 0 ]; then
    echo >&2 "Indexer on toscrape at depth 2 failed"
    exit 1
fi







#/********************************** Indextest Testing block *****************************************/
echo "========================================================="
=========================================================
echo "************ Indextest Testing block ******************"
************ Indextest Testing block ******************

echo " Section 2: Testing indextest error handling "
 Section 2: Testing indextest error handling 

echo "Note: only basic argument number tests were done as per  REQUIREMENTS"
Note: only basic argument number tests were done as per  REQUIREMENTS



# 2 arguments
echo "Error-handling: Insufficient arguments"
Error-handling: Insufficient arguments
./indextest ../tse-index-output/letters-depth-1/
incorrect number of parameters
if [ $? -ne 0 ]; then
    echo >&2 "Error caught: Insufficient arguments provided"
fi
Error caught: Insufficient arguments provided



# 4 arguments
echo "Error-handling: Too many arguments"
Error-handling: Too many arguments
./indextest ../tse-index-output/letters-depth-1/ ../tse-index/output/ ../tse-output/
incorrect number of parameters
if [ $? -ne 0 ]; then
    echo >&2 "Error caught: Too many arguments provided"
fi
Error caught: Too many arguments provided



#*********************** Regular(valid) cases testing block for indextest **********************#
echo "============================================================"
============================================================
# The tests cases defined in this block should  all pass 
echo " Also comparing sorted files of indexer and indextest "
 Also comparing sorted files of indexer and indextest 

#solutions_path=/thayerfs/courses/21fall/cosc050.02/workspace/cs50tse/tse-output

# include indexsort.awk to sort the files and creat the directory to hold those files
chmod +x indexsort.awk
mkdir ../tse-index-sorted
mkdir ../tse-sorted-indextest
mkdir ../tse-indextest-output


echo "Testing indextest on letters at depth 0, 1, 2, 3, 4, 5"
Testing indextest on letters at depth 0, 1, 2, 3, 4, 5
echo "Note: These are simple closed sets of cross-linked web pages"
Note: These are simple closed sets of cross-linked web pages




# indextest on letters at depth 0
echo "Testing indextest on letters at depth 0 file"
Testing indextest on letters at depth 0 file
./indextest ../tse-index-output/letters-index-0 ../tse-indextest-output/letters-index-0
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "Indextest on letters at depth 0 failed"
    exit 1
fi

# "Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
./indexsort.awk ../tse-index-output/letters-index-0 > ../tse-index-sorted/letters-index-0-sorted
./indexsort.awk ../tse-indextest-output/letters-index-0 > ../tse-sorted-indextest/letters-index-0-sorted


diff -qy ../tse-index-sorted/letters-index-0-sorted ../tse-sorted-indextest/letters-index-0-sorted 
if [ $? -ne 0 ]; then
    echo >&2 "letters depth 0 indexer and indextest files are different "
    echo " "
    exit 1
fi




# indextest on letters at depth 1
echo "Testing indextest on letters at depth 1 file"
Testing indextest on letters at depth 1 file
./indextest ../tse-index-output/letters-index-1 ../tse-indextest-output/letters-index-1
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 " Indextest on letters at depth 1 failed"
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
./indexsort.awk ../tse-index-output/letters-index-1 > ../tse-index-sorted/letters-index-1-sorted
./indexsort.awk ../tse-indextest-output/letters-index-1 > ../tse-sorted-indextest/letters-index-1-sorted


diff -qy ../tse-index-sorted/letters-index-1-sorted ../tse-sorted-indextest/letters-index-1-sorted 
if [ $? -ne 0 ]; then
    echo >&2 "letters depth 1 indexer and indextest files are different "
    echo " "
    exit 1
fi





# indextest on letters at depth 2
echo "Testing indextest on letters at depth 2 file"
Testing indextest on letters at depth 2 file
./indextest ../tse-index-output/letters-index-2 ../tse-indextest-output/letters-index-2
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "Indextest on letters at depth 2 failed"
    echo " "
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
./indexsort.awk ../tse-index-output/letters-index-2 > ../tse-index-sorted/letters-index-2-sorted
./indexsort.awk ../tse-indextest-output/letters-index-2 > ../tse-sorted-indextest/letters-index-2-sorted

diff -qy ../tse-index-sorted/letters-index-2-sorted ../tse-sorted-indextest/letters-index-2-sorted 
if [ $? -ne 0 ]; then
    echo >&2 "letters depth 2 indexer and indextest files are different "
    exit 1
fi





# indextest on letters at depth 3
echo "Testing indextest on letters at depth 3 file"
Testing indextest on letters at depth 3 file
./indextest ../tse-index-output/letters-index-3 ../tse-indextest-output/letters-index-3
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "Indextest on letters at depth 3 failed"
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
./indexsort.awk ../tse-index-output/letters-index-3 > ../tse-index-sorted/letters-index-3-sorted
./indexsort.awk ../tse-indextest-output/letters-index-3 > ../tse-sorted-indextest/letters-index-3-sorted


diff -qy ../tse-index-sorted/letters-index-3-sorted ../tse-sorted-indextest/letters-index-3-sorted 
if [ $? -ne 0 ]; then
    echo >&2 "letters depth 3 indexer and indextest files are different "
    echo " "
    exit 1
fi




# indextest on letters at depth 4
echo "Testing indextest on letters at depth 4 file"
Testing indextest on letters at depth 4 file
./indextest ../tse-index-output/letters-index-4 ../tse-indextest-output/letters-index-4
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "Indextest on letters at depth 4 failed"
     echo " "
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
./indexsort.awk ../tse-index-output/letters-index-4 > ../tse-index-sorted/letters-index-4-sorted
./indexsort.awk ../tse-indextest-output/letters-index-4 > ../tse-sorted-indextest/letters-index-4-sorted

diff -qy ../tse-index-sorted/letters-index-4-sorted ../tse-sorted-indextest/letters-index-4-sorted 
if [ $? -ne 0 ]; then
    echo >&2 "letters depth 4 indexer and indextest files are different "
     echo " "
    exit 1
fi




echo "Manual verification of files -- no words are missing or duplicated"
Manual verification of files -- no words are missing or duplicated

echo "==============================================================="
===============================================================
echo "Testing indextest on Wikipedia playground at depth 0, 1, 2"
Testing indextest on Wikipedia playground at depth 0, 1, 2


# indextest on wikipedia at depth 0
echo "Testing indextest on Wikipedia at depth 0 file"
Testing indextest on Wikipedia at depth 0 file
./indextest ../tse-index-output/wikipedia-index-0 ../tse-indextest-output/wikipedia-index-0
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "indextest on wikipedia at depth 0 failed"
     echo " "
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
# sort both files
./indexsort.awk ../tse-index-output/wikipedia-index-0 > ../tse-index-sorted/wikipedia-index-0-sorted
./indexsort.awk ../tse-indextest-output/wikipedia-index-0 > ../tse-sorted-indextest/wikipedia-index-0-sorted

# compare
diff -qy ../tse-index-sorted/wikipedia-index-0-sorted ../tse-sorted-indextest/wikipedia-index-0-sorted 
if [ $? -ne 0 ]; then
    echo >&2 "wikipedia depth 0 indexer and indextest files are different "
    exit 1
fi




# indextest on wikipedia at depth 1
echo "Testing indextest on Wikipedia at depth 1 file"
Testing indextest on Wikipedia at depth 1 file
./indextest ../tse-index-output/wikipedia-index-1 ../tse-indextest-output/wikipedia-index-1
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "indextest on wikipedia at depth 1 failed"
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
# sort both files
./indexsort.awk ../tse-index-output/wikipedia-index-1 > ../tse-index-sorted/wikipedia-index-1-sorted
./indexsort.awk ../tse-indextest-output/wikipedia-index-1 > ../tse-sorted-indextest/wikipedia-index-1-sorted

# compare
diff -qy ../tse-index-sorted/wikipedia-index-1-sorted ../tse-sorted-indextest/wikipedia-index-1-sorted 
if [ $? -ne 0 ]; then
    echo >&2 "wikipedia depth 1 indexer and indextest files are different "
    exit 1
fi




# indextest on wikipedia at depth 2
echo "Testing indextest on Wikipedia at depth 2 file"
Testing indextest on Wikipedia at depth 2 file
./indextest ../tse-index-output/wikipedia-index-2 ../tse-indextest-output/wikipedia-index-2
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "indextest on wikipedia at depth 2 failed"
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
# sort both files
./indexsort.awk ../tse-index-output/wikipedia-index-2 > ../tse-index-sorted/wikipedia-index-2-sorted
./indexsort.awk ../tse-indextest-output/wikipedia-index-2 > ../tse-sorted-indextest/wikipedia-index-2-sorted


# compare 
diff -qy ../tse-index-sorted/wikipedia-index-2-sorted ../tse-sorted-indextest/wikipedia-index-2-sorted 

if [ $? -ne 0 ]; then
    echo >&2 "wikipedia depth 2 indexer and indextest files are different "
    exit 1
fi





echo "==============================================================="
===============================================================
echo "Testing indextest on toscrape at depth 0, 1, 2"
Testing indextest on toscrape at depth 0, 1, 2


# indextest on toscrape at depth 0
echo "Testing indextest on toscrape at depth 0 file"
Testing indextest on toscrape at depth 0 file
./indextest ../tse-index-output/toscrape-index-0 ../tse-indextest-output/toscrape-index-0
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "indextest on toscrape at depth 0 failed"
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
# sort both files
./indexsort.awk ../tse-index-output/toscrape-index-0 > ../tse-index-sorted/toscrape-index-0-sorted
./indexsort.awk ../tse-indextest-output/toscrape-index-0 > ../tse-sorted-indextest/toscrape-index-0-sorted


# compare 
diff -qy ../tse-index-sorted/toscrape-index-0-sorted ../tse-sorted-indextest/toscrape-index-0-sorted 

if [ $? -ne 0 ]; then
    echo >&2 "toscrape depth 0 indexer and indextest files are different "
    exit 1
fi


# indextest on toscrape at depth 1
echo "Testing indextest on toscrape at depth 0 file"
Testing indextest on toscrape at depth 0 file
./indextest ../tse-index-output/toscrape-index-1 ../tse-indextest-output/toscrape-index-1
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "indextest on toscrape at depth 1 failed"
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
# sort both files
./indexsort.awk ../tse-index-output/toscrape-index-1 > ../tse-index-sorted/toscrape-index-1-sorted
./indexsort.awk ../tse-indextest-output/toscrape-index-1 > ../tse-sorted-indextest/toscrape-index-1-sorted


# compare 
diff -qy ../tse-index-sorted/toscrape-index-1-sorted ../tse-sorted-indextest/toscrape-index-1-sorted 

if [ $? -ne 0 ]; then
    echo >&2 "toscrape depth 1 indexer and indextest files are different "
    exit 1
fi


# indextest on toscrape at depth 2
echo "Testing indextest on toscrape at depth 2 file"
Testing indextest on toscrape at depth 2 file
./indextest ../tse-index-output/toscrape-index-2 ../tse-indextest-output/toscrape-index-2
Loading index...
Saving index...
Index Loaded and Saved in Indextest.
if [ $? -ne 0 ]; then
    echo >&2 "indextest on toscrape at depth 2 failed"
    exit 1
fi

# Comparing differences between indextest sorted output and that of with indexer sorted "
echo "Comparing differences between indextest sorted output and that of with indexer sorted "
Comparing differences between indextest sorted output and that of with indexer sorted 
# sort both files
./indexsort.awk ../tse-index-output/toscrape-index-2 > ../tse-index-sorted/toscrape-index-2-sorted
./indexsort.awk ../tse-indextest-output/toscrape-index-2 > ../tse-sorted-indextest/toscrape-index-2-sorted


# compare 
diff -qy ../tse-index-sorted/toscrape-index-2-sorted ../tse-sorted-indextest/toscrape-index-2-sorted 

if [ $? -ne 0 ]; then
    echo >&2 "toscrape depth 2 indexer and indextest files are different "
    exit 1
fi

echo "=============================================================="
==============================================================
echo "================== End of testing.sh =================="
================== End of testing.sh ==================

exit 0
